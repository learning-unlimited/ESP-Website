
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>On-Site Schedule Printer</title>
<script type="text/javascript" src="/media/scripts/jquery.js"></script>
<script type="text/javascript" src="/media/scripts/common.js"></script>
<script type="text/javascript">
<!--

var timer;

function reset_reload(millis)
{
    clearTimeout(timer);
    timer = setTimeout(fetch_blob, millis);
}

function fetch_blob()
{
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '?gen_img=blob&q=' + new Date().getTime());
    xhr.responseType = 'blob';
    xhr.onload = function () {
        if (this.response && this.response.size > 0) {
            var blob = new Blob([this.response], { type: 'application/pdf' });
            var url = URL.createObjectURL(blob);
            var auto_reload_blob = $j('#auto_reload_blob');
            auto_reload_blob.attr('src', url);
            // The setTimeout is needed because if we try to print
            // immediately, the previous schedule is printed instead.
            setTimeout(print_iframe, 1000);
        } else {
            reset_reload(5000);
        }
    }
    xhr.send();
}

function print_iframe()
{
    var auto_reload_blob = document.getElementById('auto_reload_blob');
    if (!auto_reload_blob.contentWindow) {
        setTimeout(print_iframe, 1000);
        return;
    }
    auto_reload_blob.contentWindow.print();
    // TODO(cjq): fix this so we get this data too
    var entry = $j('<div>').text(
        // "[" + data.time_executed + "] Executed print request #"
        // + data.id + " for " + data.user
        // + " (requested at " + data.time_requested + ")"
        "[" + Date.now() + "] Executed print request"
    );
    entry.insertAfter("#log");
    fetch_blob();
}

fetch_blob();

//-->
</script>
</head>
<body>
<div id="page_rest">
<h1 id="banner">I AM THE THING THAT MAKES SCHEDULE PRINTING WORK, DON'T TOUCH ME</h1>
<div style="height: 20em; overflow-y: auto; border: 1px solid black; padding: 0.5em">
<div id="log">Log of print requests (view <a href="/admin/utils/printrequest/?o=-3">all print requests on the admin panel</a>):</div>
</div>
</div>
<iframe id="auto_reload_blob" src="about:blank" style="visibility: hidden" />
</body>
</html>
