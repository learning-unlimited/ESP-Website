{% extends "main.html" %}

{% block title %}{{program.niceName}} Management{% endblock %}

{% block stylesheets %}
    {{ block.super }}
    <link rel='stylesheet' type='text/css' href='/media/styles/forms.css' />
    <link rel='stylesheet' type='text/css' href='/media/styles/barcodescanner.css' />
    <link rel="stylesheet" type='text/css' href="https://use.fontawesome.com/releases/v5.0.9/css/all.css">
{% endblock %}

{% block javascript %}
    {{ block.super }}
    <script src="https://webrtc.github.io/adapter/adapter-latest.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/gh/serratus/quaggaJS@e96eb9f7888507689cf33f1e6ce325959dde314e/dist/quagga.min.js" type="text/javascript"></script>
    <script src="/media/scripts/barcodescanner.js" type="text/javascript"></script>
    <script>
        Quagga.onDetected(function(result) {
            var code = result.codeResult.code;
            var autocheckin = document.getElementById("autocheckinbox");
            var data = {}
            $j('#checkinform input[type="checkbox"]').each(function() {
                data[this.name] = this.checked;
            });

            if (App.lastResult !== code) {
                App.lastResult = code;
                beep();
                if (autocheckin.checked){
                    data["code"] = code;
                    data["csrfmiddlewaretoken"] = csrf_token();
                    $j.post('ajaxbarcodecheckin', data, function(result) {
                        if (result.hasOwnProperty('message')) {
                            var message = result.message;
                            $j('#scaninfo').show();
                            $j('#scaninfo').html(message);
                            setTimeout("$j('#scaninfo').fadeOut(); ", 4000);
                        }
                    }, "json");
                } else {
                    var results = document.querySelector('#checkinform > p > textarea')
                    results.value += "\n" + code
                }
            }
        });
    </script>
{% endblock %}

{% block content %}

<h1>Barcode Checkin &mdash; For {{ program.niceName }}</h1>

<div id='program_form'>
    <p>
    Welcome to barcode check-in for {{ program.niceName }}.  Please enter a list of user IDs.
    </p>

    {% if results %}
    <div class="alert alert-info">
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
        <span>
        Checked in {{ results.new|length }} students.  {{ results.not_found|length }} students were not found, {{ results.existing|length }} students were already checked in, and {{ results.not_student|length }} IDs did not correspond to students.
        </span>
        {% if results.paid %}
        <span>
        {{ results.paid|length }} student(s) paid.
        </span>
        {% endif %}
        {% if results.liab %}
        <span>
        {{ results.liab|length }} student(s) handed in their liability waiver.
        </span>
        {% endif %}
        {% if results.med %}
        <span>
        {{ results.med|length }} student(s) handed in their medical waiver.
        </span>
        {% endif %}
        {% if results.not_found %}
        <span>
        Students not found:
        {% for id in results.not_found %}
        {{ id }}{% if not forloop.last %},{% endif %}
        {% endfor %}
        </span>
        {% endif %}
        {% if results.not_student %}
        <span>
        IDs not corresponding to students:
        {% for id in results.not_student %}
        {{ id }}{% if not forloop.last %},{% endif %}
        {% endfor %}
        </span>
        {% endif %}
        {% comment %}
        {% if results.existing %}
        <span>
        IDs already checked in:
        {% for id in results.existing %}
        {{ id }}{% if not forloop.last %},{% endif %}
        {% endfor %}
        </span>
        {% endif %}
        {% endcomment %}
    </div>
    {% endif %}

    <form id="checkinform" name="checkinform" method="POST" action="{{ request.path }}">
        <table style="width: unset;">
            {{ form.as_table }}
            <tr><td colspan="2"><input type="submit" value="Submit" /></td></tr>
        </table>
        
    </form>

    <br><br>

    <div class="controls">
        <button type="button" class="scan"><i class="fas fa-barcode"></i>&ensp;Scan barcodes with your device</button>
        <br><br>
        <select>
            <option selected value="code_39_reader">Code 39</option>
            <option value="codabar_reader">Codabar</option>
            <option value="code_128_reader">Code 128</option>
            <option value="i2of5_reader">Interleaved 2 of 5</option>
        </select>
        <br><br>
        <input type="checkbox" class="btn" id="autocheckinbox" value="autocheckin" checked><label for="autocheckinbox">Auto-checkin scanned barcodes</label><br>
    </div>
    <div class="overlay overlay--inline">
        <div class="overlay__content viewport" id="interactive">
            <div id="scaninfo" class="scan_popup"></div>
            <div class="overlay__close">X</div>
        </div>
    </div>
</div>

{% include "program/modules/onsitecore/returnlink.html" %}

{% endblock %}
