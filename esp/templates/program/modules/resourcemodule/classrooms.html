{% ifequal open_section "classroom" %}
<!-- Not in a dspcont div. The section below always shows -->
<h2>Step 3: Classrooms</h2>
<br />
{% else %}
<p class="dspsection">
<a href="javascript:void(0)" class="dsphead" onclick="expand_disp(this)">
   <span class="dspchar">+</span> <b>Step 3: Classrooms</b> (click to expand/contract)
</a>

<div class="dspcont">
{% endifequal %}

<p>Resources may be grouped or may remain floating.  For example, an LCD projector built into the classroom would be grouped with that classroom, whereas one of the projectors that we can carry around would not be grouped with anything.  When you create a classroom, please select the types of resources that it has built in.  These resources will be created and grouped with the classroom itself.</p>

{% if past_program %}
<p style="color: #990000; font-weight: bold;">Classrooms have been imported from {{ past_program.niceName }}.</p>
{% endif %}

<div id="program_form">
<form method="post" action="/manage/{{ prog.url }}/resources/classroom_import">
<table align="center" cellpadding="0" cellspacing="0" width="100%">
    <tr><th colspan="2" class="small">Import classrooms from a previous program</th></tr>
    {{ import_classroom_form }}
    <tr><td colspan="2" align="center"><input class="fancybutton" type="submit" value="Start" /></td></tr>
</table>
</form>

{% with furnishing_formset.empty_form as form %}
    <div id="id_empty_form" style="display:none;">
        {{ form.furnishing }} {{ form.choice }}
    </div>
{% endwith %}

<form method="post" action="/manage/{{ prog.url }}/resources/classroom">
<input type="hidden" name="command" value="addedit" />
<table align="center" cellpadding="0" cellspacing="0" width="100%">
    <tr><th colspan="2" class="small">Add/modify a classroom</th></tr>
    {{ classroom_form }}
    <tr>
        <th><label>Furnishings:<br>(optional)</label></th>
        <td>
            <div id="furnishing_formset">
            {{ furnishing_formset.management_form }}
            {% if not furnishing_formset.0 %}
                <div class="furnishing-formset"></div>
            {% else %}
                {% for furnishing_form in furnishing_formset %}
                    <div class="furnishing-formset">
                        {{ furnishing_form.furnishing }} {{ furnishing_form.choice }}
                    </div>
                {% endfor %}
            {% endif %}
            </div>
        </td>
    </tr>
    <tr><td colspan="2" align="center"><input class="fancybutton" type="submit" value="Update Classroom" /></td></tr>
</table>
</form>

<table align="center" cellpadding="0" cellspacing="0" width="100%">
    <tr><th colspan="2">Classrooms for {{ prog.niceName }}</th></tr>
    <tr><td colspan="2"><table cellpadding="0" cellspacing="0" width="100%">
    <tr>
        <td class="underline"><b>Room</b></td>
        <td class="underline"><b>Capacity</b></td>
        <td class="underline"><b>Timeslots</b></td>
        <td class="underline"><b>Furnishings</b></td>
    </tr>
    {% for c in prog.groupedClassrooms %}
    <tr>
        <td class="underline">
            <div id="classroom-{{ c.id }}">{{ c.name }}</div>
            <br />
                <a href="/manage/{{ prog.url }}/resources/classroom?op=edit&id={{ c.id }}">[Edit]</a>
                <a href="/manage/{{ prog.url }}/resources/classroom?op=delete&id={{ c.id }}">[Delete]</a>
        </td>
        <td class="underline">{{ c.num_students }}</td>
        <td class="underline">{% for t in c.timegroup %}{{ t }}<br />{% endfor %}</td>
        <td class="underline">
            <ol>
            {% for f in c.furnishings %}
            <li>{{ f.res_type.name }}{% if f.res_type.hidden %} (Hidden){% endif %}{% if f.attribute_value %}: {{ f.attribute_value }}{% endif %}</li>
            {% endfor %}</td>
            </ol>
    </tr>
    {% endfor %}
    </table></td></tr>
</table>
</div>

{% ifequal open_section "classroom" %}
<!-- Not in a dspcont div. -->
{% else %}
</div>
</p>
{% endifequal %}

<br />

<!--This branch has a fix for when the form is originally hidden-->
<script src="https://rawgit.com/elo80ka/django-dynamic-formset/f5f68c818953ddf43ffa7cb2e9aa391c3d4dfb47/src/jquery.formset.js"></script>
<!--jQuery.initialize plugin is created to help maintain dynamically created elements on the page-->
<script src="https://rawgit.com/pie6k/jquery.initialize/master/jquery.initialize.js"></script>
<script>
<!--Formset settings-->
$j('.furnishing-formset').formset({
    prefix: 'furnishings',
    formTemplate: '#id_empty_form',
    addText: 'add furnishing',
    deleteText: 'remove',
    addCssClass: 'furnishing-add',
    deleteCssClass: 'furnishing-delete',
    formCssClass: 'furnishing-dynamic-form',
});

<!--Get choices for a furnishing via POST-->
function getChoices(furnishing, callback){
    var data = {furnishing: furnishing, csrfmiddlewaretoken: csrf_token()};
    $j.post('/manage/{{ prog.url }}/ajaxfurnishingchoices', data, "json").success(callback);
}

<!--Update the option field to reflect whether there are specific choices (dropdown) or not (open response). If a value is supplied, set that value as selected afterwards.-->
function update_choices(obj, value) {
    var furnishing = $j(obj).val()
    getChoices(furnishing, function(response) {
        var choices = response.choices;
        var num = $j(obj).attr('id').split("-")[1];
        $j('#id_furnishings-' + num + '-choice').remove();
        if (choices.length > 1) {
            $j(obj).after('<select style="margin-left: 4px" id="id_furnishings-' + num + '-choice" name="furnishings-' + num + '-choice" type="text"></select>');
            $j('#id_furnishings-' + num + '-choice').append('<option>(option)</option>');
            for (i in choices) {
                $j('#id_furnishings-' + num + '-choice').append('<option value=' + choices[i] + '>' + choices[i] + '</option>');
            }
        } else {
            $j(obj).after('<input style="margin-left: 4px" id="id_furnishings-' + num + '-choice" name="furnishings-' + num + '-choice" maxlength="50" placeholder="(option)" type="text"></select>');
        }
        if (value) {
            $j('#id_furnishings-' + num + '-choice').val(value);
        }
    });
}

<!--Upon page load and dynamic creation of new selects-->
$j.initialize("select", function() {
    <!--Selects start with (option) or (furnishing) by default, but we want to hide these as options in the dropdown.-->
    var opt = $j(this).find("option")[0];
    $j(opt).hide();
    $j(opt).css("display", "none");
    opt.disabled = true;
    <!--Convert option field to dropdown if necessary-->
    if ($j(this).attr('id').split("-")[2] == "furnishing") {
        var num = $j(this).attr('id').split("-")[1];
        <!--Make sure to preserve selected value-->
        var value = $j('#id_furnishings-' + num + '-choice').val();
        if (value) {
            update_choices($j(this), value);
        }
    }
}, { target: $j("#furnishing_formset")[0] });

<!--Whenever a new furnishing is selected, update the respective option field-->
$j('.furnishing-dynamic-form select').change(function() {
    update_choices($j(this));
});
</script>
